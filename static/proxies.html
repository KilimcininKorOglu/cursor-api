<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/x-icon" href="data:image/x-icon;," />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‰ª£ÁêÜ‰ø°ÊÅØManagement</title>
  <!-- Include shared styles -->
  <link rel="stylesheet" href="/static/shared-styles.css" />
  <script src="/static/shared.js"></script>
  <style>
    /* ‰ª£ÁêÜÂàóË°®Â∏ÉÂ±ÄÊ†∑Âºè */
    .proxy-system {
      background: var(--card-background);
      border-radius: var(--border-radius);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      margin-top: var(--spacing);
      overflow: hidden;
      height: calc(100vh - 250px);
      display: flex;
      flex-direction: column;
    }

    .toolbar {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      border-bottom: 1px solid var(--border-color);
      background: var(--card-background);
      gap: 8px;
    }

    .toolbar .search-box {
      flex: 1;
      position: relative;
    }

    .toolbar .search-box input {
      width: 100%;
      padding-left: 36px;
      padding-right: 36px;
    }

    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-secondary);
      pointer-events: none;
    }

    .clear-search {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      background: transparent;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      display: none;
      min-height: auto;
      transition: all var(--transition-fast);
    }

    .clear-search:hover {
      background: var(--primary-color-alpha);
      color: var(--text-primary);
    }

    .clear-search.show {
      display: block;
    }

    .proxy-list {
      flex: 1;
      overflow: auto;
      position: relative;
      user-select: none;
      background: var(--card-background);
    }

    /* Ë°®Ê†ºÊªöÂä®Êó∂ÁöÑÈò¥ÂΩ±ÊïàÊûú */
    .proxy-list.scrolled .proxy-table thead {
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .proxy-table {
      width: 100%;
      border-collapse: collapse;
      margin: 0;
    }

    .proxy-table thead {
      position: sticky;
      top: 0;
      z-index: 10;
      background: var(--card-background);
      transition: box-shadow var(--transition-fast);
    }

    .proxy-table th {
      padding: 12px 16px;
      text-align: left;
      font-weight: 500;
      border-bottom: 2px solid var(--border-color);
      color: var(--text-primary);
      white-space: nowrap;
    }

    .proxy-table td {
      padding: 10px 16px;
      border-bottom: 1px solid var(--border-color);
      color: var(--text-primary);
    }

    .proxy-table tbody tr {
      cursor: pointer;
      transition: background-color var(--transition-fast);
    }

    .proxy-table tbody tr:hover {
      background: var(--primary-color-alpha);
    }

    .proxy-table tbody tr.selected {
      background: var(--primary-color-alpha);
      position: relative;
    }

    .proxy-table tbody tr.selected td:first-child {
      position: relative;
      padding-left: 20px;
    }

    .proxy-table tbody tr.selected td:first-child::before {
      content: "";
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: var(--primary-color);
    }

    .proxy-table tbody tr.general {
      font-weight: 600;
    }

    .proxy-table tbody tr.general .proxy-name::after {
      content: " ‚≠ê";
      color: var(--primary-color);
    }

    /* ‰ª£ÁêÜTypeÂõæÊ†á */
    .proxy-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      margin-right: 8px;
      font-size: 16px;
    }

    /* Á©∫StatusÊ†∑Âºè */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
      text-align: center;
      color: var(--text-secondary);
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-state h3 {
      margin: 0 0 8px 0;
      color: var(--text-primary);
    }

    .empty-state p {
      margin: 0 0 24px 0;
    }

    /* StatusÊ†è */
    .status-bar {
      padding: 8px 16px;
      background: var(--card-background);
      border-top: 1px solid var(--border-color);
      color: var(--text-secondary);
      font-size: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .status-info {
      display: flex;
      gap: 16px;
    }

    /* Âè≥ÈîÆËèúÂçï */
    .context-menu {
      position: fixed;
      background: var(--card-background);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      padding: 4px 0;
      z-index: 1000;
      min-width: 200px;
      display: none;
      animation: contextMenuIn 0.15s ease-out;
    }

    @keyframes contextMenuIn {
      from {
        opacity: 0;
        transform: scale(0.95);
      }

      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .context-menu-item {
      padding: 8px 16px;
      cursor: pointer;
      transition: all var(--transition-fast);
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: var(--text-primary);
    }

    .context-menu-item:hover,
    .context-menu-item:focus {
      background: var(--primary-color-alpha);
      outline: none;
    }

    .context-menu-item.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .context-menu-item.disabled:hover {
      background: transparent;
    }

    .context-menu-divider {
      height: 1px;
      background: var(--border-color);
      margin: 4px 0;
    }

    .context-menu-shortcut {
      margin-left: auto;
      padding-left: 16px;
      color: var(--text-secondary);
      font-size: 12px;
      opacity: 0.7;
    }

    /* FilterÈù¢Êùø */
    .filter-panel {
      padding: 16px;
      background: var(--card-background);
      border-radius: var(--border-radius);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      margin-top: var(--spacing);
    }

    .filter-row {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }

    .filter-group {
      flex: 1;
      min-width: 250px;
    }

    /* Â§öÈÄâ‰∏ãÊãâÊ°ÜÊ†∑Âºè */
    .multiselect {
      position: relative;
      width: 100%;
    }

    .multiselect-dropdown {
      width: 100%;
      padding: 8px 12px;
      background: var(--card-background);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      min-height: 44px;
      transition: all var(--transition-fast);
    }

    .multiselect-dropdown:hover {
      border-color: var(--primary-color);
    }

    .multiselect-dropdown.active {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px var(--primary-color-alpha);
    }

    .multiselect-dropdown::after {
      content: "‚ñº";
      font-size: 12px;
      color: var(--text-secondary);
      transition: transform var(--transition-fast);
    }

    .multiselect-dropdown.active::after {
      transform: rotate(180deg);
    }

    .multiselect-options {
      position: absolute;
      top: calc(100% + 4px);
      left: 0;
      right: 0;
      z-index: 100;
      background: var(--card-background);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      max-height: 240px;
      overflow-y: auto;
      display: none;
      animation: dropdownIn 0.2s ease-out;
    }

    @keyframes dropdownIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .multiselect-options.show {
      display: block;
    }

    .multiselect-option {
      padding: 8px 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      transition: background-color var(--transition-fast);
    }

    .multiselect-option:hover {
      background: var(--primary-color-alpha);
    }

    .multiselect-option input[type="checkbox"] {
      margin-right: 8px;
      pointer-events: none;
    }

    .multiselect-option label {
      margin: 0;
      cursor: pointer;
      user-select: none;
      flex: 1;
    }

    .selected-options {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      flex: 1;
    }

    .selected-option {
      background: var(--primary-color-alpha);
      color: var(--primary-color);
      padding: 2px 8px;
      border-radius: 4px;
      display: inline-flex;
      align-items: center;
      font-size: 13px;
      font-weight: 500;
    }

    .selected-options-placeholder {
      color: var(--text-secondary);
    }

    /* ÂØπËØùÊ°ÜÊ†∑Âºè */
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
      display: none;
      animation: fadeIn 0.2s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    .modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.9);
      background: var(--card-background);
      padding: 24px;
      border-radius: var(--border-radius);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      display: none;
      animation: modalIn 0.2s ease-out forwards;
    }

    @keyframes modalIn {
      to {
        transform: translate(-50%, -50%) scale(1);
      }
    }

    .modal-header {
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 20px;
    }

    .modal-close {
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: all var(--transition-fast);
    }

    .modal-close:hover {
      background: var(--primary-color-alpha);
      color: var(--text-primary);
    }

    .modal-body {
      margin-bottom: 20px;
    }

    .modal-footer {
      padding-top: 16px;
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    /* Âä†ËΩΩÈ™®Êû∂Â±è */
    .skeleton {
      animation: skeleton-loading 1s linear infinite alternate;
    }

    @keyframes skeleton-loading {
      0% {
        background-color: var(--border-color);
      }

      100% {
        background-color: var(--disabled-bg);
      }
    }

    .skeleton-row {
      height: 48px;
      margin-bottom: 1px;
    }

    /* ResponseÂºèËÆæËÆ° */
    @media (max-width: 768px) {
      .filter-row {
        flex-direction: column;
      }

      .filter-group {
        min-width: 100%;
      }

      .proxy-table {
        font-size: 14px;
      }

      .proxy-table th,
      .proxy-table td {
        padding: 8px 12px;
      }

      /* ÁßªÂä®Á´ØË°®Ê†º‰ºòÂåñ */
      .proxy-table thead th:nth-child(3) {
        display: none;
      }

      .proxy-table tbody td:nth-child(3) {
        display: none;
      }

      .status-info {
        flex-direction: column;
        gap: 4px;
        font-size: 12px;
      }

      .modal {
        width: 95%;
        padding: 16px;
      }
    }

    /* È´òÂØπÊØîÂ∫¶Ê®°ÂºèÊîØÊåÅ */
    @media (prefers-contrast: high) {
      .proxy-table tbody tr.selected td:first-child::before {
        width: 5px;
      }

      .context-menu,
      .multiselect-options {
        border-width: 2px;
      }
    }

    /* ÂáèÂ∞ëÂä®ÁîªÊ®°Âºè */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
  </style>
</head>

<body>
  <h1>‰ª£ÁêÜ‰ø°ÊÅØManagement</h1>

  <div class="container">
    <div class="form-group">
      <label for="authToken">Authentication Token:</label>
      <input type="password" id="authToken" placeholder="Enter AUTH_TOKEN" aria-label="Authentication Token" />
    </div>
  </div>

  <!-- FilterÈù¢Êùø -->
  <div class="filter-panel">
    <div class="filter-row">
      <div class="filter-group">
        <label for="proxyTypeFilter">‰ª£ÁêÜType:</label>
        <div class="multiselect" id="proxyTypeFilter">
          <div class="multiselect-dropdown" role="button" tabindex="0" aria-haspopup="listbox" aria-expanded="false">
            <div class="selected-options" id="selectedProxyTypes">
              <span class="selected-options-placeholder">ËØ∑Select‰ª£ÁêÜType...</span>
            </div>
          </div>
          <div class="multiselect-options" role="listbox" aria-multiselectable="true">
            <div class="multiselect-option" role="option" data-value="non">
              <input type="checkbox" id="type-non" value="non" checked />
              <label for="type-non">No Proxy</label>
            </div>
            <div class="multiselect-option" role="option" data-value="sys">
              <input type="checkbox" id="type-sys" value="sys" checked />
              <label for="type-sys">System‰ª£ÁêÜ</label>
            </div>
            <div class="multiselect-option" role="option" data-value="http">
              <input type="checkbox" id="type-http" value="http" checked />
              <label for="type-http">HTTP</label>
            </div>
            <div class="multiselect-option" role="option" data-value="https">
              <input type="checkbox" id="type-https" value="https" checked />
              <label for="type-https">HTTPS</label>
            </div>
            <div class="multiselect-option" role="option" data-value="socks4">
              <input type="checkbox" id="type-socks4" value="socks4" checked />
              <label for="type-socks4">SOCKS4</label>
            </div>
            <div class="multiselect-option" role="option" data-value="socks5">
              <input type="checkbox" id="type-socks5" value="socks5" checked />
              <label for="type-socks5">SOCKS5</label>
            </div>
            <div class="multiselect-option" role="option" data-value="socks5h">
              <input type="checkbox" id="type-socks5h" value="socks5h" checked />
              <label for="type-socks5h">SOCKS5H</label>
            </div>
          </div>
        </div>
      </div>
      <div class="filter-group">
        <label class="visually-hidden">ActionsÊåâÈíÆ</label>
        <div class="button-group">
          <button id="refreshBtn" onclick="getProxyInfo()" class="primary" title="Refresh‰ª£ÁêÜÂàóË°® (F5)">
            <span>Refresh List</span>
            <span class="context-menu-shortcut">F5</span>
          </button>
          <button id="addProxyBtn" onclick="showAddProxyModal()" class="secondary" title="AddÊñ∞‰ª£ÁêÜ">
            Add‰ª£ÁêÜ
          </button>
          <button id="exportBtn" onclick="exportProxies()" class="secondary" title="Export‰ª£ÁêÜConfiguration">
            ExportConfiguration
          </button>
          <button id="importBtn" onclick="showImportModal()" class="secondary" title="Import‰ª£ÁêÜConfiguration">
            ImportConfiguration
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ‰ª£ÁêÜÂàóË°®Âå∫Âüü -->
  <div class="proxy-system">
    <div class="toolbar">
      <div class="search-box">
        <span class="search-icon">üîç</span>
        <input type="text" id="searchInput" placeholder="Search‰ª£ÁêÜName..." aria-label="Search‰ª£ÁêÜ" />
        <button class="clear-search" id="clearSearch" onclick="clearSearchInput()" aria-label="Ê∏ÖÈô§Search">
          ‚úï
        </button>
      </div>
    </div>

    <div class="proxy-list" id="proxyListContainer">
      <table class="proxy-table" role="table">
        <thead>
          <tr role="row">
            <th role="columnheader" style="width: 30%">‰ª£ÁêÜName</th>
            <th role="columnheader" style="width: 25%">‰ª£ÁêÜType</th>
            <th role="columnheader" style="width: 45%">‰ª£ÁêÜAddress</th>
          </tr>
        </thead>
        <tbody id="proxyListBody" role="rowgroup">
          <!-- Âä®ÊÄÅÁîüÊàêÁöÑ‰ª£ÁêÜÂàóË°® -->
        </tbody>
      </table>
      <div id="emptyState" class="empty-state" style="display: none">
        <div class="empty-state-icon">üåê</div>
        <h3>No Proxy Found</h3>
        <p>ËØ∑Add‰ª£ÁêÜÊàñÊõ¥ÊîπFilterrecords‰ª∂</p>
        <button onclick="showAddProxyModal()" class="primary">
          Add‰ª£ÁêÜ
        </button>
      </div>
      <div id="loadingState" class="skeleton" style="display: none">
        <div class="skeleton-row skeleton"></div>
        <div class="skeleton-row skeleton"></div>
        <div class="skeleton-row skeleton"></div>
      </div>
    </div>

    <div class="status-bar">
      <div class="status-info">
        <span id="selectionStatus">Â∑≤Select: 0 </span>
        <span id="totalCount">Total 0 ‰ª£ÁêÜ</span>
      </div>
    </div>
  </div>

  <!-- Âè≥ÈîÆËèúÂçï -->
  <div id="contextMenu" class="context-menu" role="menu">
    <div class="context-menu-item" onclick="setAsGeneral()" role="menuitem" tabindex="0">
      <span>Set as General Proxy</span>
      <span class="context-menu-shortcut">Ctrl+G</span>
    </div>
    <div class="context-menu-item" onclick="copyProxyUrl()" role="menuitem" tabindex="0">
      <span>Copy‰ª£ÁêÜAddress</span>
      <span class="context-menu-shortcut">Ctrl+C</span>
    </div>
    <div class="context-menu-divider" role="separator"></div>
    <div class="context-menu-item" onclick="deleteSelectedProxies()" role="menuitem" tabindex="0">
      <span>Delete</span>
      <span class="context-menu-shortcut">Delete</span>
    </div>
  </div>

  <!-- Add‰ª£ÁêÜÂØπËØùÊ°Ü -->
  <div class="modal-backdrop" id="addProxyModal-backdrop" onclick="closeModal('addProxyModal')"></div>
  <div class="modal" id="addProxyModal" role="dialog" aria-labelledby="addProxyTitle" aria-modal="true">
    <div class="modal-header">
      <h3 id="addProxyTitle">Add‰ª£ÁêÜ</h3>
      <button class="modal-close" onclick="closeModal('addProxyModal')" aria-label="CloseÂØπËØùÊ°Ü">
        √ó
      </button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label for="proxyName">‰ª£ÁêÜName:</label>
        <input type="text" id="proxyName" placeholder="ËæìÂÖ•‰ª£ÁêÜName" required />
      </div>
      <div class="form-group">
        <label for="proxyType">‰ª£ÁêÜType:</label>
        <select id="proxyType" onchange="toggleProxyUrl()">
          <option value="non">No Proxy</option>
          <option value="sys">System‰ª£ÁêÜ</option>
          <option value="custom" selected>Custom‰ª£ÁêÜ</option>
        </select>
      </div>
      <div class="form-group" id="proxyUrlGroup">
        <label for="proxyUrl">‰ª£ÁêÜAddress:</label>
        <input type="text" id="proxyUrl" placeholder="e.g.: http://localhost:7890" />
        <div class="help-text">
          Supported formats: http://localhost:7890,
          socks5://username:password@localhost:1080
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button onclick="closeModal('addProxyModal')" class="secondary">
        Cancel
      </button>
      <button onclick="confirmAddProxy()" class="primary">Add</button>
    </div>
  </div>

  <!-- ConfirmDeleteÂØπËØùÊ°Ü -->
  <div class="modal-backdrop" id="confirmModal-backdrop" onclick="closeModal('confirmModal')"></div>
  <div class="modal" id="confirmModal" role="dialog" aria-labelledby="confirmTitle" aria-modal="true">
    <div class="modal-header">
      <h3 id="confirmTitle">ConfirmDelete</h3>
      <button class="modal-close" onclick="closeModal('confirmModal')" aria-label="CloseÂØπËØùÊ°Ü">
        √ó
      </button>
    </div>
    <div class="modal-body">
      <p id="confirmMessage">OKË¶ÅDeleteÈÄâ‰∏≠ÁöÑ‰ª£ÁêÜÂêóÔºü</p>
    </div>
    <div class="modal-footer">
      <button onclick="closeModal('confirmModal')" class="secondary">
        Cancel
      </button>
      <button onclick="confirmDeleteProxies()" class="danger">Delete</button>
    </div>
  </div>

  <!-- ImportÂØπËØùÊ°Ü -->
  <div class="modal-backdrop" id="importModal-backdrop" onclick="closeModal('importModal')"></div>
  <div class="modal" id="importModal" role="dialog" aria-labelledby="importTitle" aria-modal="true">
    <div class="modal-header">
      <h3 id="importTitle">Import‰ª£ÁêÜConfiguration</h3>
      <button class="modal-close" onclick="closeModal('importModal')" aria-label="CloseÂØπËØùÊ°Ü">
        √ó
      </button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label for="importFile">SelectJSONÊñá‰ª∂:</label>
        <input type="file" id="importFile" accept=".json" onchange="previewImportFile()" />
      </div>
      <div id="importPreview" style="display: none; margin-top: 16px">
        <h4>File Preview:</h4>
        <pre id="importPreviewContent" style="
            background: var(--disabled-bg);
            padding: 12px;
            border-radius: 4px;
            overflow: auto;
            max-height: 200px;
          "></pre>
      </div>
    </div>
    <div class="modal-footer">
      <button onclick="closeModal('importModal')" class="secondary">
        Cancel
      </button>
      <button id="confirmImportBtn" onclick="confirmImport()" class="primary" disabled>
        Import
      </button>
    </div>
  </div>

  <!-- ÂÖ®Â±ÄÈÄöÁü•Âå∫Âüü -->
  <div id="toast-container" class="toast-container"></div>

  <script>
    // ÂÖ®Â±ÄÂèòÈáè
    let allProxies = {};
    let generalProxy = "";
    let selectedProxies = new Set();
    let proxiesToDelete = [];
    let searchDebounceTimer = null;

    // ÂàùÂßãÂåñTokenHandling
    initializeTokenHandling("authToken");

    // ÂàùÂßãÂåñ
    document.addEventListener("DOMContentLoaded", () => {
      // Ëé∑Âèñ‰ª£ÁêÜ‰ø°ÊÅØ
      getProxyInfo();

      // ÁõëÂê¨SearchËæìÂÖ•ÔºàÈò≤ÊäñÔºâ
      const searchInput = document.getElementById("searchInput");
      searchInput.addEventListener("input", (e) => {
        clearTimeout(searchDebounceTimer);
        const value = e.target.value;

        // Show/HideÊ∏ÖÈô§ÊåâÈíÆ
        const clearBtn = document.getElementById("clearSearch");
        clearBtn.classList.toggle("show", value.length > 0);

        // Èò≤ÊäñSearch
        searchDebounceTimer = setTimeout(() => {
          filterProxies();
        }, 300);
      });

      // ÁõëÂê¨‰ª£ÁêÜÂàóË°®ÊªöÂä®
      const proxyListContainer =
        document.getElementById("proxyListContainer");
      proxyListContainer.addEventListener("scroll", () => {
        const scrolled = proxyListContainer.scrollTop > 0;
        proxyListContainer.classList.toggle("scrolled", scrolled);
      });

      // ÂàùÂßãÂåñÂ§öÈÄâ‰∏ãÊãâÊ°Ü
      initMultiSelect();

      // SettingsÈîÆÁõòÂø´Êç∑ÈîÆ
      setupKeyboardShortcuts();

      // Settings‰∏ä‰∏ãÊñáËèúÂçï
      setupContextMenu();

      updateStatusBar();
    });

    // ÂàùÂßãÂåñÂ§öÈÄâ‰∏ãÊãâÊ°Ü
    function initMultiSelect() {
      const dropdown = document.querySelector(".multiselect-dropdown");
      const options = document.querySelector(".multiselect-options");

      // ÁÇπÂáª‰∏ãÊãâÊ°ÜShow/HideÈÄâitems
      dropdown.addEventListener("click", function (e) {
        e.stopPropagation();
        const isOpen = dropdown.classList.contains("active");

        if (isOpen) {
          closeMultiSelect();
        } else {
          openMultiSelect();
        }
      });

      // ÈîÆÁõòÂØºËà™ÊîØÊåÅ
      dropdown.addEventListener("keydown", function (e) {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          dropdown.click();
        }
      });

      // ÁÇπÂáªÂ§ñÈÉ®Close‰∏ãÊãâÊ°Ü
      document.addEventListener("click", function (e) {
        if (!e.target.closest(".multiselect")) {
          closeMultiSelect();
        }
      });

      // ÁõëÂê¨ÈÄâitemsÁÇπÂáª
      const optionDivs = document.querySelectorAll(".multiselect-option");
      optionDivs.forEach((div) => {
        div.addEventListener("click", function (e) {
          e.stopPropagation();
          const checkbox = this.querySelector('input[type="checkbox"]');
          checkbox.checked = !checkbox.checked;
          checkbox.dispatchEvent(new Event("change"));
        });

        // ÁõëÂê¨Â§çÈÄâÊ°ÜÂèòÂåñ
        const checkbox = div.querySelector('input[type="checkbox"]');
        checkbox.addEventListener("change", function () {
          updateSelectedOptions();
          filterProxies();
        });
      });

      // ÂàùÂßãÂåñÂ∑≤ÈÄâitems
      updateSelectedOptions();
    }

    // ÊâìÂºÄÂ§öÈÄâ‰∏ãÊãâÊ°Ü
    function openMultiSelect() {
      const dropdown = document.querySelector(".multiselect-dropdown");
      const options = document.querySelector(".multiselect-options");

      dropdown.classList.add("active");
      dropdown.setAttribute("aria-expanded", "true");
      options.classList.add("show");
    }

    // CloseÂ§öÈÄâ‰∏ãÊãâÊ°Ü
    function closeMultiSelect() {
      const dropdown = document.querySelector(".multiselect-dropdown");
      const options = document.querySelector(".multiselect-options");

      dropdown.classList.remove("active");
      dropdown.setAttribute("aria-expanded", "false");
      options.classList.remove("show");
    }

    // UpdateÂ∑≤ÈÄâÈÄâitemsShow
    function updateSelectedOptions() {
      const selectedContainer = document.getElementById("selectedProxyTypes");
      const checkboxes = document.querySelectorAll(
        ".multiselect-option input:checked",
      );

      if (checkboxes.length === 0) {
        selectedContainer.innerHTML =
          '<span class="selected-options-placeholder">ËØ∑Select‰ª£ÁêÜType...</span>';
        return;
      }

      let html = "";
      checkboxes.forEach((checkbox) => {
        const label = checkbox.nextElementSibling.textContent;
        html += `<span class="selected-option">${label}</span>`;
      });

      selectedContainer.innerHTML = html;
    }

    // Ê∏ÖÈô§SearchËæìÂÖ•
    function clearSearchInput() {
      const searchInput = document.getElementById("searchInput");
      const clearBtn = document.getElementById("clearSearch");

      searchInput.value = "";
      clearBtn.classList.remove("show");
      filterProxies();
      searchInput.focus();
    }

    // Ê£ÄÊµãYesMacËøòYesÂÖ∂‰ªñSystem
    function isModifierKey(e) {
      const isMac = navigator.platform.toUpperCase().indexOf("MAC") >= 0;
      return isMac ? e.metaKey : e.ctrlKey;
    }

    // SettingsÈîÆÁõòÂø´Êç∑ÈîÆ
    function setupKeyboardShortcuts() {
      document.addEventListener("keydown", function (e) {
        // ÂøΩÁï•ËæìÂÖ•Ê°Ü‰∏≠ÁöÑÂø´Êç∑ÈîÆ
        if (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA") {
          return;
        }

        switch (e.key) {
          case "Delete":
            e.preventDefault();
            deleteSelectedProxies();
            break;
          case "F5":
            e.preventDefault();
            getProxyInfo();
            break;
          case "g":
            if (isModifierKey(e)) {
              e.preventDefault();
              setAsGeneral();
            }
            break;
          case "c":
            if (isModifierKey(e)) {
              e.preventDefault();
              copyProxyUrl();
            }
            break;
          case "a":
            if (isModifierKey(e)) {
              e.preventDefault();
              selectAllProxies();
            }
            break;
          case "Escape":
            closeAllModals();
            closeContextMenu();
            closeMultiSelect();
            break;
        }
      });
    }

    // Settings‰∏ä‰∏ãÊñáËèúÂçï
    function setupContextMenu() {
      const proxyList = document.querySelector(".proxy-list");
      const contextMenu = document.getElementById("contextMenu");

      // Âè≥ÈîÆÁÇπÂáªShowËèúÂçï
      proxyList.addEventListener("contextmenu", function (e) {
        const row = e.target.closest("tr");

        if (!row || row.closest("thead")) return;
        if (!row.dataset.name) return;

        e.preventDefault();

        const proxyName = row.dataset.name;

        if (!selectedProxies.has(proxyName)) {
          clearSelection();
          selectProxy(proxyName);
        }

        updateContextMenuItems();
        showContextMenu(e.pageX, e.pageY);
      });

      // ÁÇπÂáªÂÖ∂‰ªñÂú∞ÊñπCloseËèúÂçï
      document.addEventListener("click", function () {
        closeContextMenu();
      });

      // ÈòªÊ≠¢Âè≥ÈîÆËèúÂçïÂÜÖÈÉ®ÁÇπÂáªÂØºËá¥ËèúÂçïClose
      contextMenu.addEventListener("click", function (e) {
        e.stopPropagation();
      });

      // ÈîÆÁõòÂØºËà™ÊîØÊåÅ
      setupContextMenuKeyboardNav();
    }

    // SettingsÂè≥ÈîÆËèúÂçïÈîÆÁõòÂØºËà™
    function setupContextMenuKeyboardNav() {
      const contextMenu = document.getElementById("contextMenu");
      const items = contextMenu.querySelectorAll(
        ".context-menu-item:not(.disabled)",
      );

      items.forEach((item, index) => {
        item.addEventListener("keydown", function (e) {
          switch (e.key) {
            case "ArrowDown":
              e.preventDefault();
              const nextIndex = (index + 1) % items.length;
              items[nextIndex].focus();
              break;
            case "ArrowUp":
              e.preventDefault();
              const prevIndex = (index - 1 + items.length) % items.length;
              items[prevIndex].focus();
              break;
            case "Enter":
            case " ":
              e.preventDefault();
              item.click();
              break;
            case "Escape":
              e.preventDefault();
              closeContextMenu();
              break;
          }
        });
      });
    }

    // ShowÂè≥ÈîÆËèúÂçï
    function showContextMenu(x, y) {
      const menu = document.getElementById("contextMenu");

      // ÂÖàSettingsÂú®Èº†Ê†á‰ΩçÁΩÆÔºåÁÑ∂ÂêéË∞ÉÊï¥ÈÅøÂÖçË∂ÖÂá∫ËæπÁïå
      menu.style.left = x + "px";
      menu.style.top = y + "px";
      menu.style.display = "block";

      // Ë∞ÉÊï¥‰ΩçÁΩÆ‰ª•ÈÅøÂÖçË∂ÖÂá∫ËæπÁïå
      positionContextMenu(menu, x, y);

      // ËÅöÁÑ¶Page‰∏ÄAvailableitems
      const firstItem = menu.querySelector(
        ".context-menu-item:not(.disabled)",
      );
      if (firstItem) {
        firstItem.focus();
      }
    }

    // CloseÂè≥ÈîÆËèúÂçï
    function closeContextMenu() {
      const contextMenu = document.getElementById("contextMenu");
      contextMenu.style.display = "none";
    }

    // UpdateÂè≥ÈîÆËèúÂçïitemsStatus
    function updateContextMenuItems() {
      const selectedCount = selectedProxies.size;
      const items = document.querySelectorAll(".context-menu-item");

      items.forEach((item) => {
        // Ê†πÊçÆSelectStatusEnable/DisableËèúÂçïitems
        if (item.onclick.toString().includes("setAsGeneral")) {
          item.classList.toggle("disabled", selectedCount !== 1);
        }
      });
    }

    // ËÆ°ÁÆóËèúÂçï‰ΩçÁΩÆ
    function positionContextMenu(menu, x, y) {
      menu.style.visibility = "hidden";
      menu.style.display = "block";

      const windowWidth = window.innerWidth;
      const windowHeight = window.innerHeight;
      const menuWidth = menu.offsetWidth;
      const menuHeight = menu.offsetHeight;

      let adjustedX = x;
      let adjustedY = y;

      if (x + menuWidth > windowWidth - 10) {
        adjustedX = windowWidth - menuWidth - 10;
      }

      if (y + menuHeight > windowHeight - 10) {
        adjustedY = windowHeight - menuHeight - 10;
      }

      menu.style.left = Math.max(10, adjustedX) + "px";
      menu.style.top = Math.max(10, adjustedY) + "px";
      menu.style.visibility = "visible";
    }

    // Ëé∑Âèñ‰ª£ÁêÜ‰ø°ÊÅØ
    async function getProxyInfo() {
      showLoadingState();
      showToast("Loading‰ª£ÁêÜÂàóË°®...", "info");

      const data = await makeAuthenticatedRequest("/proxies/get");

      if (data) {
        allProxies = data.proxies || {};
        generalProxy = data.general_proxy || "";
        renderProxies();
        updateStatusBar();
        showToast(
          `‰ª£ÁêÜÂàóË°®Â∑≤UpdateÔºöTotal ${data.proxies_count || 0} `,
          "success",
        );
      } else {
        showToast("Ëé∑Âèñ‰ª£ÁêÜÂàóË°®Failed", "error");
        hideLoadingState();
      }
    }

    // ShowÂä†ËΩΩStatus
    function showLoadingState() {
      const loadingState = document.getElementById("loadingState");
      const emptyState = document.getElementById("emptyState");
      const proxyListBody = document.getElementById("proxyListBody");

      loadingState.style.display = "block";
      emptyState.style.display = "none";
      proxyListBody.innerHTML = "";
    }

    // HideÂä†ËΩΩStatus
    function hideLoadingState() {
      const loadingState = document.getElementById("loadingState");
      loadingState.style.display = "none";
    }

    // Ê∏≤Êüì‰ª£ÁêÜÂàóË°®
    function renderProxies() {
      const proxyListBody = document.getElementById("proxyListBody");
      const emptyState = document.getElementById("emptyState");
      const loadingState = document.getElementById("loadingState");

      loadingState.style.display = "none";

      const proxyEntries = Object.entries(allProxies);

      if (proxyEntries.length === 0) {
        proxyListBody.innerHTML = "";
        emptyState.style.display = "flex";
        return;
      }

      emptyState.style.display = "none";

      proxyListBody.innerHTML = proxyEntries
        .map(([name, value]) => {
          const isGeneral = name === generalProxy;
          const type = getProxyType(value);
          const url = type === "non" || type === "sys" ? "-" : value;
          const icon = getProxyIcon(type);

          return `
        <tr role="row" data-name="${escapeHtml(name)}" class="${selectedProxies.has(name) ? "selected" : ""} ${isGeneral ? "general" : ""}">
          <td><span class="proxy-icon">${icon}</span><span class="proxy-name">${escapeHtml(name)}</span></td>
          <td>${formatProxyType(type)}</td>
          <td>${escapeHtml(url)}</td>
        </tr>
      `;
        })
        .join("");

      // AddÁÇπÂáª‰∫ã‰ª∂Â§ÑÁêÜ
      setupProxyRowEvents();
    }

    // Settings‰ª£ÁêÜË°å‰∫ã‰ª∂
    function setupProxyRowEvents() {
      const rows = document.querySelectorAll("#proxyListBody tr");
      rows.forEach((row) => {
        row.addEventListener("click", function (e) {
          const name = this.dataset.name;

          if (e.shiftKey && selectedProxies.size > 0) {
            // Shift+ÁÇπÂáªËøõË°åRangeSelect
            selectRange(name);
          } else if (isModifierKey(e)) {
            // Ctrl/Cmd+ÁÇπÂáªËøõË°åÂ§öÈÄâ
            if (selectedProxies.has(name)) {
              deselectProxy(name);
            } else {
              selectProxy(name, true);
            }
          } else {
            // ÊôÆÈÄöÁÇπÂáª
            clearSelection();
            selectProxy(name);
          }

          updateSelectionStatus();
        });
      });
    }

    // SelectRangeÂÜÖÁöÑ‰ª£ÁêÜ
    function selectRange(endName) {
      const rows = Array.from(document.querySelectorAll("#proxyListBody tr"));
      const lastSelected = Array.from(selectedProxies).pop();

      const startIndex = rows.findIndex(
        (row) => row.dataset.name === lastSelected,
      );
      const endIndex = rows.findIndex((row) => row.dataset.name === endName);

      if (startIndex === -1 || endIndex === -1) return;

      const [min, max] = [
        Math.min(startIndex, endIndex),
        Math.max(startIndex, endIndex),
      ];

      for (let i = min; i <= max; i++) {
        const name = rows[i].dataset.name;
        selectProxy(name, true);
      }
    }

    // SelectÊâÄÊúâ‰ª£ÁêÜ
    function selectAllProxies() {
      const rows = document.querySelectorAll("#proxyListBody tr");
      rows.forEach((row) => {
        const name = row.dataset.name;
        selectProxy(name, true);
      });
      updateSelectionStatus();
    }

    // HTMLËΩ¨‰πâ
    function escapeHtml(text) {
      const div = document.createElement("div");
      div.textContent = text;
      return div.innerHTML;
    }

    // Ëé∑Âèñ‰ª£ÁêÜÂõæÊ†á
    function getProxyIcon(type) {
      const icons = {
        non: "üö´",
        sys: "üñ•Ô∏è",
        http: "üåê",
        https: "üîí",
        socks4: "üß¶",
        socks5: "üß¶",
        socks5h: "üß¶",
        unknown: "‚ùì",
      };
      return icons[type] || icons.unknown;
    }

    // Ëé∑Âèñ‰ª£ÁêÜType
    function getProxyType(value) {
      if (value === "non") return "non";
      if (value === "sys") return "sys";
      try {
        const proxyUrl = new URL(value);
        const protocol = proxyUrl.protocol.replace(":", "");
        return protocol;
      } catch (e) {
        return "unknown";
      }
    }

    // Ê†ºÂºèÂåñ‰ª£ÁêÜType
    function formatProxyType(type) {
      const types = {
        non: "No Proxy",
        sys: "System‰ª£ÁêÜ",
        http: "HTTP",
        https: "HTTPS",
        socks4: "SOCKS4",
        socks5: "SOCKS5",
        socks5h: "SOCKS5H",
        unknown: "Êú™Áü•",
      };
      return types[type] || type;
    }

    // È™åËØÅ‰ª£ÁêÜAddressÊ†ºÂºè
    function validateProxyUrl(url, type) {
      if (type === "non" || type === "sys") return true;

      try {
        const proxyUrl = new URL(url);
        const protocol = proxyUrl.protocol.replace(":", "");

        const validProtocols = [
          "http",
          "https",
          "socks4",
          "socks5",
          "socks5h",
        ];
        if (!validProtocols.includes(protocol)) {
          showToast(`Unsupported proxy protocol: ${protocol}`, "warning");
          return false;
        }

        if (!proxyUrl.hostname || !proxyUrl.port) {
          showToast("‰ª£ÁêÜAddressÂøÖÈ°ªÂåÖÂê´‰∏ªÊú∫ÂêçÂíåÁ´ØÂè£Âè∑", "warning");
          return false;
        }

        return true;
      } catch (e) {
        showToast("‰ª£ÁêÜAddressÊ†ºÂºèNoneÊïà", "warning");
        return false;
      }
    }

    // Filter‰ª£ÁêÜ
    function filterProxies() {
      const searchTerm = document
        .getElementById("searchInput")
        .value.toLowerCase();
      const selectedTypes = Array.from(
        document.querySelectorAll(".multiselect-option input:checked"),
      ).map((cb) => cb.value);

      const filteredProxies = Object.entries(allProxies).filter(
        ([name, value]) => {
          const type = getProxyType(value);
          const nameMatch = name.toLowerCase().includes(searchTerm);
          const typeMatch = selectedTypes.includes(type);

          return nameMatch && typeMatch;
        },
      );

      const filteredObj = Object.fromEntries(filteredProxies);
      renderFilteredProxies(filteredObj);
      updateStatusBar(filteredProxies.length);
    }

    // Ê∏≤ÊüìFilterÂêéÁöÑ‰ª£ÁêÜ
    function renderFilteredProxies(proxies) {
      const temp = allProxies;
      allProxies = proxies;
      renderProxies();
      allProxies = temp;
    }

    // UpdateStatusÊ†è
    function updateStatusBar(filteredCount) {
      const total = Object.keys(allProxies).length;
      const selected = selectedProxies.size;
      const selectionStatus = document.getElementById("selectionStatus");
      const totalCount = document.getElementById("totalCount");

      if (selectionStatus) {
        selectionStatus.textContent = `Â∑≤Select: ${selected} `;
      }
      if (totalCount) {
        const count = filteredCount !== undefined ? filteredCount : total;
        totalCount.textContent = `Total ${count} ‰ª£ÁêÜ`;
      }
    }

    // Select‰ª£ÁêÜ
    function selectProxy(name, append = false) {
      if (!name) return;

      if (!append) {
        clearSelection();
      }

      selectedProxies.add(name);
      const row = document.querySelector(`tr[data-name="${name}"]`);
      if (row) {
        row.classList.add("selected");
      }

      updateSelectionStatus();
    }

    // CancelSelect‰ª£ÁêÜ
    function deselectProxy(name) {
      if (!name) return;

      selectedProxies.delete(name);
      const row = document.querySelector(`tr[data-name="${name}"]`);
      if (row) {
        row.classList.remove("selected");
      }

      updateSelectionStatus();
    }

    // Ê∏ÖÈô§ÊâÄÊúâSelect
    function clearSelection() {
      selectedProxies.clear();
      const rows = document.querySelectorAll("#proxyListBody tr.selected");
      rows.forEach((row) => {
        row.classList.remove("selected");
      });

      updateSelectionStatus();
    }

    // UpdateSelectStatus
    function updateSelectionStatus() {
      updateStatusBar();
    }

    // ShowAdd‰ª£ÁêÜÂØπËØùÊ°Ü
    function showAddProxyModal() {
      document.getElementById("proxyName").value = "";
      document.getElementById("proxyType").value = "custom";
      document.getElementById("proxyUrl").value = "";
      toggleProxyUrl();
      showModal("addProxyModal");

      // ËÅöÁÑ¶Page‰∏ÄËæìÂÖ•Ê°Ü
      setTimeout(() => {
        document.getElementById("proxyName").focus();
      }, 200);
    }

    // ÂàáÊç¢‰ª£ÁêÜAddressËæìÂÖ•Ê°ÜShow
    function toggleProxyUrl() {
      const type = document.getElementById("proxyType").value;
      const urlGroup = document.getElementById("proxyUrlGroup");
      urlGroup.style.display = type === "custom" ? "block" : "none";
    }

    // ConfirmAdd‰ª£ÁêÜ
    async function confirmAddProxy() {
      const name = document.getElementById("proxyName").value.trim();
      const type = document.getElementById("proxyType").value;
      const url = document.getElementById("proxyUrl").value.trim();

      if (!name) {
        showToast("ËØ∑ËæìÂÖ•‰ª£ÁêÜName", "warning");
        document.getElementById("proxyName").focus();
        return;
      }

      if (type === "custom") {
        if (!url) {
          showToast("ËØ∑ËæìÂÖ•‰ª£ÁêÜAddress", "warning");
          document.getElementById("proxyUrl").focus();
          return;
        }

        if (!validateProxyUrl(url, type)) {
          return;
        }
      }

      closeModal("addProxyModal");
      showToast("Ê≠£Âú®Add‰ª£ÁêÜ...", "info");

      const proxy = {
        [name]: type === "non" || type === "sys" ? type : url,
      };

      const data = await makeAuthenticatedRequest("/proxies/add", {
        body: JSON.stringify({
          proxies: proxy,
        }),
      });

      if (data) {
        showToast(data.message || "AddSuccess", "success");
        getProxyInfo();
      } else {
        showToast("Add‰ª£ÁêÜFailed", "error");
      }
    }

    // DeleteÈÄâ‰∏≠ÁöÑ‰ª£ÁêÜ
    function deleteSelectedProxies() {
      if (selectedProxies.size === 0) {
        showToast("ËØ∑ÂÖàSelectË¶ÅDeleteÁöÑ‰ª£ÁêÜ", "info");
        return;
      }

      proxiesToDelete = [...selectedProxies];
      document.getElementById("confirmMessage").textContent =
        proxiesToDelete.length > 1
          ? `OKË¶ÅDeleteÈÄâ‰∏≠ÁöÑ ${proxiesToDelete.length} ‰ª£ÁêÜÂêóÔºü`
          : "OKË¶ÅDeleteÈÄâ‰∏≠ÁöÑ‰ª£ÁêÜÂêóÔºü";

      closeContextMenu();
      showModal("confirmModal");
    }

    // ConfirmDelete‰ª£ÁêÜ
    async function confirmDeleteProxies() {
      if (proxiesToDelete.length === 0) return;

      closeModal("confirmModal");
      showToast("Ê≠£Âú®Delete‰ª£ÁêÜ...", "info");

      const data = await makeAuthenticatedRequest("/proxies/del", {
        body: JSON.stringify({
          names: proxiesToDelete,
          expectation: "failed_tokens",
        }),
      });

      if (data) {
        const failedCount = data.failed_names?.length || 0;
        const successCount = proxiesToDelete.length - failedCount;
        const message = failedCount
          ? `DeleteSuccess: ${successCount} ÔºåFailed: ${failedCount} `
          : `SuccessDelete ${successCount} ‰ª£ÁêÜ`;

        showToast(message, "success");
        clearSelection();
        getProxyInfo();
      } else {
        showToast("Delete‰ª£ÁêÜFailed", "error");
      }

      proxiesToDelete = [];
    }

    // Settings‰∏∫ÈÄöÁî®‰ª£ÁêÜ
    async function setAsGeneral() {
      if (selectedProxies.size !== 1) {
        showToast("ËØ∑Select‰∏Ä‰ª£ÁêÜSet as General Proxy", "info");
        return;
      }

      closeContextMenu();

      const name = [...selectedProxies][0];
      showToast("Ê≠£Âú®SettingsÈÄöÁî®‰ª£ÁêÜ...", "info");

      const data = await makeAuthenticatedRequest("/proxies/set-general", {
        body: JSON.stringify({
          name: name,
        }),
      });

      if (data) {
        showToast("ÈÄöÁî®‰ª£ÁêÜSettingsSuccess", "success");
        getProxyInfo();
      } else {
        showToast("SettingsÈÄöÁî®‰ª£ÁêÜFailed", "error");
      }
    }

    // Copy‰ª£ÁêÜAddress
    async function copyProxyUrl() {
      if (selectedProxies.size === 0) {
        showToast("ËØ∑ÂÖàSelect‰ª£ÁêÜ", "info");
        return;
      }

      const name = [...selectedProxies][0];
      const value = allProxies[name];

      closeContextMenu();

      if (typeof value === "string" && value !== "non" && value !== "sys") {
        // ‰ΩøÁî®Total‰∫´ÁöÑCopyÊñπÊ≥ï
        const success = await copyToClipboard(value, {
          showMessage: false, // ‰ΩøÁî®CustomÁöÑ toast Ê∂àÊÅØ
          onSuccess: () => {
            showToast("‰ª£ÁêÜAddressÂ∑≤CopyÂà∞Ââ™Ë¥¥Êùø", "success");
          },
          onError: () => {
            showToast("CopyFailedÔºåËØ∑ÊâãÂä®Copy", "error");
          },
        });
      } else {
        showToast("ËØ•‰ª£ÁêÜÊ≤°ÊúâÂèØCopyÁöÑAddress", "warning");
      }
    }

    // Export‰ª£ÁêÜConfiguration
    function exportProxies() {
      const config = {
        proxies: allProxies,
        general: generalProxy,
      };

      const jsonData = JSON.stringify(config, null, 2);
      const blob = new Blob([jsonData], { type: "application/json" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = `proxies_export_${new Date().toISOString().slice(0, 10)}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      showToast("‰ª£ÁêÜConfigurationÂ∑≤Export", "success");
    }

    // ShowImportÂØπËØùÊ°Ü
    function showImportModal() {
      document.getElementById("importFile").value = "";
      document.getElementById("importPreview").style.display = "none";
      document.getElementById("confirmImportBtn").disabled = true;
      showModal("importModal");
    }

    // È¢ÑËßàImportÊñá‰ª∂
    function previewImportFile() {
      const fileInput = document.getElementById("importFile");
      const preview = document.getElementById("importPreview");
      const previewContent = document.getElementById("importPreviewContent");
      const confirmBtn = document.getElementById("confirmImportBtn");

      if (!fileInput.files || fileInput.files.length === 0) {
        preview.style.display = "none";
        confirmBtn.disabled = true;
        return;
      }

      const file = fileInput.files[0];
      const reader = new FileReader();

      reader.onload = function (e) {
        try {
          const config = JSON.parse(e.target.result);

          // È™åËØÅÊñá‰ª∂Ê†ºÂºè
          if (!config.proxies || typeof config.proxies !== "object") {
            throw new Error("NoneÊïàÁöÑConfigurationÊñá‰ª∂Ê†ºÂºè");
          }

          // ShowÈ¢ÑËßà
          const proxyCount = Object.keys(config.proxies).length;
          const previewText = `‰ª£ÁêÜCount: ${proxyCount}\nÈÄöÁî®‰ª£ÁêÜ: ${config.general || "None"}\n\n‰ª£ÁêÜÂàóË°®:\n${Object.entries(
            config.proxies,
          )
            .slice(0, 10)
            .map(([name, value]) => `- ${name}: ${value}`)
            .join("\n")}${proxyCount > 10 ? "\n..." : ""}`;

          previewContent.textContent = previewText;
          preview.style.display = "block";
          confirmBtn.disabled = false;
        } catch (error) {
          showToast("Êñá‰ª∂Ê†ºÂºèNoneÊïà: " + error.message, "error");
          preview.style.display = "none";
          confirmBtn.disabled = true;
        }
      };

      reader.readAsText(file);
    }

    // ConfirmImport
    async function confirmImport() {
      const fileInput = document.getElementById("importFile");

      if (!fileInput.files || fileInput.files.length === 0) {
        showToast("ËØ∑SelectË¶ÅImportÁöÑÊñá‰ª∂", "warning");
        return;
      }

      const file = fileInput.files[0];
      const reader = new FileReader();

      reader.onload = async function (e) {
        try {
          const config = JSON.parse(e.target.result);

          closeModal("importModal");
          showToast("Ê≠£Âú®Import‰ª£ÁêÜConfiguration...", "info");

          const data = await makeAuthenticatedRequest("/proxies/set", {
            body: JSON.stringify(config),
          });

          if (data) {
            showToast("‰ª£ÁêÜConfigurationImportSuccess", "success");
            fileInput.value = "";
            getProxyInfo();
          } else {
            showToast("ImportFailed", "error");
          }
        } catch (error) {
          showToast("ImportFailed: " + error.message, "error");
        }
      };

      reader.readAsText(file);
    }

    // ShowÂØπËØùÊ°Ü
    function showModal(modalId) {
      const modal = document.getElementById(modalId);
      const backdrop = document.getElementById(`${modalId}-backdrop`);

      if (modal && backdrop) {
        modal.style.display = "block";
        backdrop.style.display = "block";
      }
    }

    // CloseÂØπËØùÊ°Ü
    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      const backdrop = document.getElementById(`${modalId}-backdrop`);

      if (modal && backdrop) {
        modal.style.display = "none";
        backdrop.style.display = "none";
      }
    }

    // CloseÊâÄÊúâÂØπËØùÊ°Ü
    function closeAllModals() {
      const modals = document.querySelectorAll(".modal");
      const backdrops = document.querySelectorAll(".modal-backdrop");

      modals.forEach((modal) => {
        modal.style.display = "none";
      });

      backdrops.forEach((backdrop) => {
        backdrop.style.display = "none";
      });
    }

    // ShowÈÄöÁü•Ê∂àÊÅØ
    function showToast(message, type = "info", duration = 3000) {
      // Ëé∑ÂèñÊàñÂàõÂª∫ÈÄöÁü•ÂÆπÂô®
      let container = document.getElementById("toast-container");
      if (!container) {
        container = document.createElement("div");
        container.id = "toast-container";
        container.className = "toast-container";
        document.body.appendChild(container);
      }

      // ÂàõÂª∫Êñ∞ÁöÑÈÄöÁü•ÂÖÉÁ¥†
      const toast = document.createElement("div");
      toast.className = `toast ${type}`;

      // AddÊñáÊú¨ÂÆπÂô®
      toast.innerHTML = `<div class="toast-content">${message}</div>`;

      // AddÂà∞ÂÆπÂô®
      container.appendChild(toast);

      // Âº∫Âà∂‰∏ÄÊ¨°ÈáçÊéíÔºåÁ°Æ‰øùËøáÊ∏°Âä®ÁîªÁîüÊïà
      void toast.offsetWidth;

      // ShowÈÄöÁü•
      requestAnimationFrame(() => {
        toast.classList.add("show");
      });

      // SettingsËá™Âä®ÁßªÈô§
      setTimeout(() => {
        toast.classList.remove("show");

        // ÈÄöÁü•Ê∂àÂ§±Âä®ÁîªÂÆåÊàêÂêéÁßªÈô§ÂÖÉÁ¥†
        setTimeout(() => {
          if (container.contains(toast)) {
            container.removeChild(toast);
          }

          // Â¶ÇÊûúÊ≤°ÊúâMoreÈÄöÁü•ÔºåÁßªÈô§ÂÆπÂô®
          if (container.children.length === 0) {
            if (document.body.contains(container)) {
              document.body.removeChild(container);
            }
          }
        }, 400);
      }, duration);

      // ÈôêÂà∂MaxShowCount
      const maxToasts = 5;
      const toasts = container.querySelectorAll(".toast");
      if (toasts.length > maxToasts) {
        const oldestToast = toasts[0];
        oldestToast.classList.remove("show");
        setTimeout(() => {
          if (container.contains(oldestToast)) {
            container.removeChild(oldestToast);
          }
        }, 400);
      }
    }
  </script>
</body>

</html>