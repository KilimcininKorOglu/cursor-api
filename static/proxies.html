<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/x-icon" href="data:image/x-icon;," />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Proxy Management</title>
  <!-- Include shared styles -->
  <link rel="stylesheet" href="/static/shared-styles.css" />
  <script src="/static/shared.js"></script>
  <style>
    /* Proxy list layout styles */
    .proxy-system {
      background: var(--card-background);
      border-radius: var(--border-radius);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      margin-top: var(--spacing);
      overflow: hidden;
      height: calc(100vh - 250px);
      display: flex;
      flex-direction: column;
    }

    .toolbar {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      border-bottom: 1px solid var(--border-color);
      background: var(--card-background);
      gap: 8px;
    }

    .toolbar .search-box {
      flex: 1;
      position: relative;
    }

    .toolbar .search-box input {
      width: 100%;
      padding-left: 36px;
      padding-right: 36px;
    }

    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-secondary);
      pointer-events: none;
    }

    .clear-search {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      background: transparent;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      display: none;
      min-height: auto;
      transition: all var(--transition-fast);
    }

    .clear-search:hover {
      background: var(--primary-color-alpha);
      color: var(--text-primary);
    }

    .clear-search.show {
      display: block;
    }

    .proxy-list {
      flex: 1;
      overflow: auto;
      position: relative;
      user-select: none;
      background: var(--card-background);
    }

    /* Table scroll shadow effect */
    .proxy-list.scrolled .proxy-table thead {
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .proxy-table {
      width: 100%;
      border-collapse: collapse;
      margin: 0;
    }

    .proxy-table thead {
      position: sticky;
      top: 0;
      z-index: 10;
      background: var(--card-background);
      transition: box-shadow var(--transition-fast);
    }

    .proxy-table th {
      padding: 12px 16px;
      text-align: left;
      font-weight: 500;
      border-bottom: 2px solid var(--border-color);
      color: var(--text-primary);
      white-space: nowrap;
    }

    .proxy-table td {
      padding: 10px 16px;
      border-bottom: 1px solid var(--border-color);
      color: var(--text-primary);
    }

    .proxy-table tbody tr {
      cursor: pointer;
      transition: background-color var(--transition-fast);
    }

    .proxy-table tbody tr:hover {
      background: var(--primary-color-alpha);
    }

    .proxy-table tbody tr.selected {
      background: var(--primary-color-alpha);
      position: relative;
    }

    .proxy-table tbody tr.selected td:first-child {
      position: relative;
      padding-left: 20px;
    }

    .proxy-table tbody tr.selected td:first-child::before {
      content: "";
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: var(--primary-color);
    }

    .proxy-table tbody tr.general {
      font-weight: 600;
    }

    .proxy-table tbody tr.general .proxy-name::after {
      content: " ‚≠ê";
      color: var(--primary-color);
    }

    /* Proxy type icon */
    .proxy-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      margin-right: 8px;
      font-size: 16px;
    }

    /* Empty state styles */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
      text-align: center;
      color: var(--text-secondary);
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-state h3 {
      margin: 0 0 8px 0;
      color: var(--text-primary);
    }

    .empty-state p {
      margin: 0 0 24px 0;
    }

    /* Status bar */
    .status-bar {
      padding: 8px 16px;
      background: var(--card-background);
      border-top: 1px solid var(--border-color);
      color: var(--text-secondary);
      font-size: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .status-info {
      display: flex;
      gap: 16px;
    }

    /* Context menu */
    .context-menu {
      position: fixed;
      background: var(--card-background);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      padding: 4px 0;
      z-index: 1000;
      min-width: 200px;
      display: none;
      animation: contextMenuIn 0.15s ease-out;
    }

    @keyframes contextMenuIn {
      from {
        opacity: 0;
        transform: scale(0.95);
      }

      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .context-menu-item {
      padding: 8px 16px;
      cursor: pointer;
      transition: all var(--transition-fast);
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: var(--text-primary);
    }

    .context-menu-item:hover,
    .context-menu-item:focus {
      background: var(--primary-color-alpha);
      outline: none;
    }

    .context-menu-item.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .context-menu-item.disabled:hover {
      background: transparent;
    }

    .context-menu-divider {
      height: 1px;
      background: var(--border-color);
      margin: 4px 0;
    }

    .context-menu-shortcut {
      margin-left: auto;
      padding-left: 16px;
      color: var(--text-secondary);
      font-size: 12px;
      opacity: 0.7;
    }

    /* Filter panel */
    .filter-panel {
      padding: 16px;
      background: var(--card-background);
      border-radius: var(--border-radius);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      margin-top: var(--spacing);
    }

    .filter-row {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }

    .filter-group {
      flex: 1;
      min-width: 250px;
    }

    /* Multi-select dropdown styles */
    .multiselect {
      position: relative;
      width: 100%;
    }

    .multiselect-dropdown {
      width: 100%;
      padding: 8px 12px;
      background: var(--card-background);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      min-height: 44px;
      transition: all var(--transition-fast);
    }

    .multiselect-dropdown:hover {
      border-color: var(--primary-color);
    }

    .multiselect-dropdown.active {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px var(--primary-color-alpha);
    }

    .multiselect-dropdown::after {
      content: "‚ñº";
      font-size: 12px;
      color: var(--text-secondary);
      transition: transform var(--transition-fast);
    }

    .multiselect-dropdown.active::after {
      transform: rotate(180deg);
    }

    .multiselect-options {
      position: absolute;
      top: calc(100% + 4px);
      left: 0;
      right: 0;
      z-index: 100;
      background: var(--card-background);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      max-height: 240px;
      overflow-y: auto;
      display: none;
      animation: dropdownIn 0.2s ease-out;
    }

    @keyframes dropdownIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .multiselect-options.show {
      display: block;
    }

    .multiselect-option {
      padding: 8px 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      transition: background-color var(--transition-fast);
    }

    .multiselect-option:hover {
      background: var(--primary-color-alpha);
    }

    .multiselect-option input[type="checkbox"] {
      margin-right: 8px;
      pointer-events: none;
    }

    .multiselect-option label {
      margin: 0;
      cursor: pointer;
      user-select: none;
      flex: 1;
    }

    .selected-options {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      flex: 1;
    }

    .selected-option {
      background: var(--primary-color-alpha);
      color: var(--primary-color);
      padding: 2px 8px;
      border-radius: 4px;
      display: inline-flex;
      align-items: center;
      font-size: 13px;
      font-weight: 500;
    }

    .selected-options-placeholder {
      color: var(--text-secondary);
    }

    /* Dialog styles */
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
      display: none;
      animation: fadeIn 0.2s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    .modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.9);
      background: var(--card-background);
      padding: 24px;
      border-radius: var(--border-radius);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      display: none;
      animation: modalIn 0.2s ease-out forwards;
    }

    @keyframes modalIn {
      to {
        transform: translate(-50%, -50%) scale(1);
      }
    }

    .modal-header {
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 20px;
    }

    .modal-close {
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: all var(--transition-fast);
    }

    .modal-close:hover {
      background: var(--primary-color-alpha);
      color: var(--text-primary);
    }

    .modal-body {
      margin-bottom: 20px;
    }

    .modal-footer {
      padding-top: 16px;
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    /* Loading skeleton */
    .skeleton {
      animation: skeleton-loading 1s linear infinite alternate;
    }

    @keyframes skeleton-loading {
      0% {
        background-color: var(--border-color);
      }

      100% {
        background-color: var(--disabled-bg);
      }
    }

    .skeleton-row {
      height: 48px;
      margin-bottom: 1px;
    }

    /* Responsive design */
    @media (max-width: 768px) {
      .filter-row {
        flex-direction: column;
      }

      .filter-group {
        min-width: 100%;
      }

      .proxy-table {
        font-size: 14px;
      }

      .proxy-table th,
      .proxy-table td {
        padding: 8px 12px;
      }

      /* Mobile table optimization */
      .proxy-table thead th:nth-child(3) {
        display: none;
      }

      .proxy-table tbody td:nth-child(3) {
        display: none;
      }

      .status-info {
        flex-direction: column;
        gap: 4px;
        font-size: 12px;
      }

      .modal {
        width: 95%;
        padding: 16px;
      }
    }

    /* High contrast mode support */
    @media (prefers-contrast: high) {
      .proxy-table tbody tr.selected td:first-child::before {
        width: 5px;
      }

      .context-menu,
      .multiselect-options {
        border-width: 2px;
      }
    }

    /* Reduced motion mode */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
  </style>
</head>

<body>
  <h1>Proxy Management</h1>

  <div class="container">
    <div class="form-group">
      <label for="authToken">Authentication Token:</label>
      <input type="password" id="authToken" placeholder="Enter AUTH_TOKEN" aria-label="Authentication Token" />
    </div>
  </div>

  <!-- Filter panel -->
  <div class="filter-panel">
    <div class="filter-row">
      <div class="filter-group">
        <label for="proxyTypeFilter">Proxy Type:</label>
        <div class="multiselect" id="proxyTypeFilter">
          <div class="multiselect-dropdown" role="button" tabindex="0" aria-haspopup="listbox" aria-expanded="false">
            <div class="selected-options" id="selectedProxyTypes">
              <span class="selected-options-placeholder">Select proxy type...</span>
            </div>
          </div>
          <div class="multiselect-options" role="listbox" aria-multiselectable="true">
            <div class="multiselect-option" role="option" data-value="non">
              <input type="checkbox" id="type-non" value="non" checked />
              <label for="type-non">No Proxy</label>
            </div>
            <div class="multiselect-option" role="option" data-value="sys">
              <input type="checkbox" id="type-sys" value="sys" checked />
              <label for="type-sys">System Proxy</label>
            </div>
            <div class="multiselect-option" role="option" data-value="http">
              <input type="checkbox" id="type-http" value="http" checked />
              <label for="type-http">HTTP</label>
            </div>
            <div class="multiselect-option" role="option" data-value="https">
              <input type="checkbox" id="type-https" value="https" checked />
              <label for="type-https">HTTPS</label>
            </div>
            <div class="multiselect-option" role="option" data-value="socks4">
              <input type="checkbox" id="type-socks4" value="socks4" checked />
              <label for="type-socks4">SOCKS4</label>
            </div>
            <div class="multiselect-option" role="option" data-value="socks5">
              <input type="checkbox" id="type-socks5" value="socks5" checked />
              <label for="type-socks5">SOCKS5</label>
            </div>
            <div class="multiselect-option" role="option" data-value="socks5h">
              <input type="checkbox" id="type-socks5h" value="socks5h" checked />
              <label for="type-socks5h">SOCKS5H</label>
            </div>
          </div>
        </div>
      </div>
      <div class="filter-group">
        <label class="visually-hidden">Action buttons</label>
        <div class="button-group">
          <button id="refreshBtn" onclick="getProxyInfo()" class="primary" title="Refresh proxy list (F5)">
            <span>Refresh List</span>
            <span class="context-menu-shortcut">F5</span>
          </button>
          <button id="addProxyBtn" onclick="showAddProxyModal()" class="secondary" title="Add new proxy">
            Add Proxy
          </button>
          <button id="exportBtn" onclick="exportProxies()" class="secondary" title="Export proxy configuration">
            Export Config
          </button>
          <button id="importBtn" onclick="showImportModal()" class="secondary" title="Import proxy configuration">
            Import Config
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Proxy list area -->
  <div class="proxy-system">
    <div class="toolbar">
      <div class="search-box">
        <span class="search-icon">üîç</span>
        <input type="text" id="searchInput" placeholder="Search proxy name..." aria-label="Search proxy" />
        <button class="clear-search" id="clearSearch" onclick="clearSearchInput()" aria-label="Clear search">
          ‚úï
        </button>
      </div>
    </div>

    <div class="proxy-list" id="proxyListContainer">
      <table class="proxy-table" role="table">
        <thead>
          <tr role="row">
            <th role="columnheader" style="width: 30%">Proxy Name</th>
            <th role="columnheader" style="width: 25%">Proxy Type</th>
            <th role="columnheader" style="width: 45%">Proxy Address</th>
          </tr>
        </thead>
        <tbody id="proxyListBody" role="rowgroup">
          <!-- Dynamically generated proxy list -->
        </tbody>
      </table>
      <div id="emptyState" class="empty-state" style="display: none">
        <div class="empty-state-icon">üåê</div>
        <h3>No Proxy Found</h3>
        <p>Please add proxy or change filter conditions</p>
        <button onclick="showAddProxyModal()" class="primary">
          Add Proxy
        </button>
      </div>
      <div id="loadingState" class="skeleton" style="display: none">
        <div class="skeleton-row skeleton"></div>
        <div class="skeleton-row skeleton"></div>
        <div class="skeleton-row skeleton"></div>
      </div>
    </div>

    <div class="status-bar">
      <div class="status-info">
        <span id="selectionStatus">Selected: 0</span>
        <span id="totalCount">Total 0 proxies</span>
      </div>
    </div>
  </div>

  <!-- Context menu -->
  <div id="contextMenu" class="context-menu" role="menu">
    <div class="context-menu-item" onclick="setAsGeneral()" role="menuitem" tabindex="0">
      <span>Set as General Proxy</span>
      <span class="context-menu-shortcut">Ctrl+G</span>
    </div>
    <div class="context-menu-item" onclick="copyProxyUrl()" role="menuitem" tabindex="0">
      <span>Copy Proxy Address</span>
      <span class="context-menu-shortcut">Ctrl+C</span>
    </div>
    <div class="context-menu-divider" role="separator"></div>
    <div class="context-menu-item" onclick="deleteSelectedProxies()" role="menuitem" tabindex="0">
      <span>Delete</span>
      <span class="context-menu-shortcut">Delete</span>
    </div>
  </div>

  <!-- Add proxy dialog -->
  <div class="modal-backdrop" id="addProxyModal-backdrop" onclick="closeModal('addProxyModal')"></div>
  <div class="modal" id="addProxyModal" role="dialog" aria-labelledby="addProxyTitle" aria-modal="true">
    <div class="modal-header">
      <h3 id="addProxyTitle">Add Proxy</h3>
      <button class="modal-close" onclick="closeModal('addProxyModal')" aria-label="Close dialog">
        √ó
      </button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label for="proxyName">Proxy Name:</label>
        <input type="text" id="proxyName" placeholder="Enter proxy name" required />
      </div>
      <div class="form-group">
        <label for="proxyType">Proxy Type:</label>
        <select id="proxyType" onchange="toggleProxyUrl()">
          <option value="non">No Proxy</option>
          <option value="sys">System Proxy</option>
          <option value="custom" selected>Custom Proxy</option>
        </select>
      </div>
      <div class="form-group" id="proxyUrlGroup">
        <label for="proxyUrl">Proxy Address:</label>
        <input type="text" id="proxyUrl" placeholder="e.g.: http://localhost:7890" />
        <div class="help-text">
          Supported formats: http://localhost:7890,
          socks5://username:password@localhost:1080
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button onclick="closeModal('addProxyModal')" class="secondary">
        Cancel
      </button>
      <button onclick="confirmAddProxy()" class="primary">Add</button>
    </div>
  </div>

  <!-- Confirm delete dialog -->
  <div class="modal-backdrop" id="confirmModal-backdrop" onclick="closeModal('confirmModal')"></div>
  <div class="modal" id="confirmModal" role="dialog" aria-labelledby="confirmTitle" aria-modal="true">
    <div class="modal-header">
      <h3 id="confirmTitle">Confirm Delete</h3>
      <button class="modal-close" onclick="closeModal('confirmModal')" aria-label="Close dialog">
        √ó
      </button>
    </div>
    <div class="modal-body">
      <p id="confirmMessage">Are you sure you want to delete the selected proxy?</p>
    </div>
    <div class="modal-footer">
      <button onclick="closeModal('confirmModal')" class="secondary">
        Cancel
      </button>
      <button onclick="confirmDeleteProxies()" class="danger">Delete</button>
    </div>
  </div>

  <!-- Import dialog -->
  <div class="modal-backdrop" id="importModal-backdrop" onclick="closeModal('importModal')"></div>
  <div class="modal" id="importModal" role="dialog" aria-labelledby="importTitle" aria-modal="true">
    <div class="modal-header">
      <h3 id="importTitle">Import Proxy Configuration</h3>
      <button class="modal-close" onclick="closeModal('importModal')" aria-label="Close dialog">
        √ó
      </button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label for="importFile">Select JSON file:</label>
        <input type="file" id="importFile" accept=".json" onchange="previewImportFile()" />
      </div>
      <div id="importPreview" style="display: none; margin-top: 16px">
        <h4>File Preview:</h4>
        <pre id="importPreviewContent" style="
            background: var(--disabled-bg);
            padding: 12px;
            border-radius: 4px;
            overflow: auto;
            max-height: 200px;
          "></pre>
      </div>
    </div>
    <div class="modal-footer">
      <button onclick="closeModal('importModal')" class="secondary">
        Cancel
      </button>
      <button id="confirmImportBtn" onclick="confirmImport()" class="primary" disabled>
        Import
      </button>
    </div>
  </div>

  <!-- Global notification area -->
  <div id="toast-container" class="toast-container"></div>

  <script>
    // Global variables
    let allProxies = {};
    let generalProxy = "";
    let selectedProxies = new Set();
    let proxiesToDelete = [];
    let searchDebounceTimer = null;

    // Initialize token handling
    initializeTokenHandling("authToken");

    // Initialize
    document.addEventListener("DOMContentLoaded", () => {
      // Get proxy info
      getProxyInfo();

      // Listen for search input (debounced)
      const searchInput = document.getElementById("searchInput");
      searchInput.addEventListener("input", (e) => {
        clearTimeout(searchDebounceTimer);
        const value = e.target.value;

        // Show/Hide clear button
        const clearBtn = document.getElementById("clearSearch");
        clearBtn.classList.toggle("show", value.length > 0);

        // Debounced search
        searchDebounceTimer = setTimeout(() => {
          filterProxies();
        }, 300);
      });

      // Listen for proxy list scroll
      const proxyListContainer =
        document.getElementById("proxyListContainer");
      proxyListContainer.addEventListener("scroll", () => {
        const scrolled = proxyListContainer.scrollTop > 0;
        proxyListContainer.classList.toggle("scrolled", scrolled);
      });

      // Initialize multi-select dropdown
      initMultiSelect();

      // Setup keyboard shortcuts
      setupKeyboardShortcuts();

      // Setup context menu
      setupContextMenu();

      updateStatusBar();
    });

    // Initialize multi-select dropdown
    function initMultiSelect() {
      const dropdown = document.querySelector(".multiselect-dropdown");
      const options = document.querySelector(".multiselect-options");

      // Click dropdown to show/hide options
      dropdown.addEventListener("click", function (e) {
        e.stopPropagation();
        const isOpen = dropdown.classList.contains("active");

        if (isOpen) {
          closeMultiSelect();
        } else {
          openMultiSelect();
        }
      });

      // Keyboard navigation support
      dropdown.addEventListener("keydown", function (e) {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          dropdown.click();
        }
      });

      // Click outside to close dropdown
      document.addEventListener("click", function (e) {
        if (!e.target.closest(".multiselect")) {
          closeMultiSelect();
        }
      });

      // Listen for option clicks
      const optionDivs = document.querySelectorAll(".multiselect-option");
      optionDivs.forEach((div) => {
        div.addEventListener("click", function (e) {
          e.stopPropagation();
          const checkbox = this.querySelector('input[type="checkbox"]');
          checkbox.checked = !checkbox.checked;
          checkbox.dispatchEvent(new Event("change"));
        });

        // Listen for checkbox changes
        const checkbox = div.querySelector('input[type="checkbox"]');
        checkbox.addEventListener("change", function () {
          updateSelectedOptions();
          filterProxies();
        });
      });

      // Initialize selected items
      updateSelectedOptions();
    }

    // Open multi-select dropdown
    function openMultiSelect() {
      const dropdown = document.querySelector(".multiselect-dropdown");
      const options = document.querySelector(".multiselect-options");

      dropdown.classList.add("active");
      dropdown.setAttribute("aria-expanded", "true");
      options.classList.add("show");
    }

    // Close multi-select dropdown
    function closeMultiSelect() {
      const dropdown = document.querySelector(".multiselect-dropdown");
      const options = document.querySelector(".multiselect-options");

      dropdown.classList.remove("active");
      dropdown.setAttribute("aria-expanded", "false");
      options.classList.remove("show");
    }

    // Update selected options display
    function updateSelectedOptions() {
      const selectedContainer = document.getElementById("selectedProxyTypes");
      const checkboxes = document.querySelectorAll(
        ".multiselect-option input:checked",
      );

      if (checkboxes.length === 0) {
        selectedContainer.innerHTML =
          '<span class="selected-options-placeholder">Select proxy type...</span>';
        return;
      }

      let html = "";
      checkboxes.forEach((checkbox) => {
        const label = checkbox.nextElementSibling.textContent;
        html += `<span class="selected-option">${label}</span>`;
      });

      selectedContainer.innerHTML = html;
    }

    // Clear search input
    function clearSearchInput() {
      const searchInput = document.getElementById("searchInput");
      const clearBtn = document.getElementById("clearSearch");

      searchInput.value = "";
      clearBtn.classList.remove("show");
      filterProxies();
      searchInput.focus();
    }

    // Detect if Mac or other system
    function isModifierKey(e) {
      const isMac = navigator.platform.toUpperCase().indexOf("MAC") >= 0;
      return isMac ? e.metaKey : e.ctrlKey;
    }

    // Setup keyboard shortcuts
    function setupKeyboardShortcuts() {
      document.addEventListener("keydown", function (e) {
        // Ignore shortcuts in input fields
        if (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA") {
          return;
        }

        switch (e.key) {
          case "Delete":
            e.preventDefault();
            deleteSelectedProxies();
            break;
          case "F5":
            e.preventDefault();
            getProxyInfo();
            break;
          case "g":
            if (isModifierKey(e)) {
              e.preventDefault();
              setAsGeneral();
            }
            break;
          case "c":
            if (isModifierKey(e)) {
              e.preventDefault();
              copyProxyUrl();
            }
            break;
          case "a":
            if (isModifierKey(e)) {
              e.preventDefault();
              selectAllProxies();
            }
            break;
          case "Escape":
            closeAllModals();
            closeContextMenu();
            closeMultiSelect();
            break;
        }
      });
    }

    // Setup context menu
    function setupContextMenu() {
      const proxyList = document.querySelector(".proxy-list");
      const contextMenu = document.getElementById("contextMenu");

      // Right click to show menu
      proxyList.addEventListener("contextmenu", function (e) {
        const row = e.target.closest("tr");

        if (!row || row.closest("thead")) return;
        if (!row.dataset.name) return;

        e.preventDefault();

        const proxyName = row.dataset.name;

        if (!selectedProxies.has(proxyName)) {
          clearSelection();
          selectProxy(proxyName);
        }

        updateContextMenuItems();
        showContextMenu(e.pageX, e.pageY);
      });

      // Click elsewhere to close menu
      document.addEventListener("click", function () {
        closeContextMenu();
      });

      // Prevent context menu internal click from closing menu
      contextMenu.addEventListener("click", function (e) {
        e.stopPropagation();
      });

      // Keyboard navigation support
      setupContextMenuKeyboardNav();
    }

    // Setup context menu keyboard navigation
    function setupContextMenuKeyboardNav() {
      const contextMenu = document.getElementById("contextMenu");
      const items = contextMenu.querySelectorAll(
        ".context-menu-item:not(.disabled)",
      );

      items.forEach((item, index) => {
        item.addEventListener("keydown", function (e) {
          switch (e.key) {
            case "ArrowDown":
              e.preventDefault();
              const nextIndex = (index + 1) % items.length;
              items[nextIndex].focus();
              break;
            case "ArrowUp":
              e.preventDefault();
              const prevIndex = (index - 1 + items.length) % items.length;
              items[prevIndex].focus();
              break;
            case "Enter":
            case " ":
              e.preventDefault();
              item.click();
              break;
            case "Escape":
              e.preventDefault();
              closeContextMenu();
              break;
          }
        });
      });
    }

    // Show context menu
    function showContextMenu(x, y) {
      const menu = document.getElementById("contextMenu");

      // First set at mouse position, then adjust to avoid overflow
      menu.style.left = x + "px";
      menu.style.top = y + "px";
      menu.style.display = "block";

      // Adjust position to avoid overflow
      positionContextMenu(menu, x, y);

      // Focus first available item
      const firstItem = menu.querySelector(
        ".context-menu-item:not(.disabled)",
      );
      if (firstItem) {
        firstItem.focus();
      }
    }

    // Close context menu
    function closeContextMenu() {
      const contextMenu = document.getElementById("contextMenu");
      contextMenu.style.display = "none";
    }

    // Update context menu item status
    function updateContextMenuItems() {
      const selectedCount = selectedProxies.size;
      const items = document.querySelectorAll(".context-menu-item");

      items.forEach((item) => {
        // Enable/Disable menu items based on selection status
        if (item.onclick.toString().includes("setAsGeneral")) {
          item.classList.toggle("disabled", selectedCount !== 1);
        }
      });
    }

    // Calculate menu position
    function positionContextMenu(menu, x, y) {
      menu.style.visibility = "hidden";
      menu.style.display = "block";

      const windowWidth = window.innerWidth;
      const windowHeight = window.innerHeight;
      const menuWidth = menu.offsetWidth;
      const menuHeight = menu.offsetHeight;

      let adjustedX = x;
      let adjustedY = y;

      if (x + menuWidth > windowWidth - 10) {
        adjustedX = windowWidth - menuWidth - 10;
      }

      if (y + menuHeight > windowHeight - 10) {
        adjustedY = windowHeight - menuHeight - 10;
      }

      menu.style.left = Math.max(10, adjustedX) + "px";
      menu.style.top = Math.max(10, adjustedY) + "px";
      menu.style.visibility = "visible";
    }

    // Get proxy info
    async function getProxyInfo() {
      showLoadingState();
      showToast("Loading proxy list...", "info");

      const data = await makeAuthenticatedRequest("/proxies/get");

      if (data) {
        allProxies = data.proxies || {};
        generalProxy = data.general_proxy || "";
        renderProxies();
        updateStatusBar();
        showToast(
          `Proxy list updated: Total ${data.proxies_count || 0}`,
          "success",
        );
      } else {
        showToast("Failed to get proxy list", "error");
        hideLoadingState();
      }
    }

    // Show loading state
    function showLoadingState() {
      const loadingState = document.getElementById("loadingState");
      const emptyState = document.getElementById("emptyState");
      const proxyListBody = document.getElementById("proxyListBody");

      loadingState.style.display = "block";
      emptyState.style.display = "none";
      proxyListBody.innerHTML = "";
    }

    // Hide loading state
    function hideLoadingState() {
      const loadingState = document.getElementById("loadingState");
      loadingState.style.display = "none";
    }

    // Render proxy list
    function renderProxies() {
      const proxyListBody = document.getElementById("proxyListBody");
      const emptyState = document.getElementById("emptyState");
      const loadingState = document.getElementById("loadingState");

      loadingState.style.display = "none";

      const proxyEntries = Object.entries(allProxies);

      if (proxyEntries.length === 0) {
        proxyListBody.innerHTML = "";
        emptyState.style.display = "flex";
        return;
      }

      emptyState.style.display = "none";

      proxyListBody.innerHTML = proxyEntries
        .map(([name, value]) => {
          const isGeneral = name === generalProxy;
          const type = getProxyType(value);
          const url = type === "non" || type === "sys" ? "-" : value;
          const icon = getProxyIcon(type);

          return `
        <tr role="row" data-name="${escapeHtml(name)}" class="${selectedProxies.has(name) ? "selected" : ""} ${isGeneral ? "general" : ""}">
          <td><span class="proxy-icon">${icon}</span><span class="proxy-name">${escapeHtml(name)}</span></td>
          <td>${formatProxyType(type)}</td>
          <td>${escapeHtml(url)}</td>
        </tr>
      `;
        })
        .join("");

      // Add click event handling
      setupProxyRowEvents();
    }

    // Setup proxy row events
    function setupProxyRowEvents() {
      const rows = document.querySelectorAll("#proxyListBody tr");
      rows.forEach((row) => {
        row.addEventListener("click", function (e) {
          const name = this.dataset.name;

          if (e.shiftKey && selectedProxies.size > 0) {
            // Shift+click for range selection
            selectRange(name);
          } else if (isModifierKey(e)) {
            // Ctrl/Cmd+click for multi-selection
            if (selectedProxies.has(name)) {
              deselectProxy(name);
            } else {
              selectProxy(name, true);
            }
          } else {
            // Normal click
            clearSelection();
            selectProxy(name);
          }

          updateSelectionStatus();
        });
      });
    }

    // Select proxies in range
    function selectRange(endName) {
      const rows = Array.from(document.querySelectorAll("#proxyListBody tr"));
      const lastSelected = Array.from(selectedProxies).pop();

      const startIndex = rows.findIndex(
        (row) => row.dataset.name === lastSelected,
      );
      const endIndex = rows.findIndex((row) => row.dataset.name === endName);

      if (startIndex === -1 || endIndex === -1) return;

      const [min, max] = [
        Math.min(startIndex, endIndex),
        Math.max(startIndex, endIndex),
      ];

      for (let i = min; i <= max; i++) {
        const name = rows[i].dataset.name;
        selectProxy(name, true);
      }
    }

    // Select all proxies
    function selectAllProxies() {
      const rows = document.querySelectorAll("#proxyListBody tr");
      rows.forEach((row) => {
        const name = row.dataset.name;
        selectProxy(name, true);
      });
      updateSelectionStatus();
    }

    // HTML escape
    function escapeHtml(text) {
      const div = document.createElement("div");
      div.textContent = text;
      return div.innerHTML;
    }

    // Get proxy icon
    function getProxyIcon(type) {
      const icons = {
        non: "üö´",
        sys: "üñ•Ô∏è",
        http: "üåê",
        https: "üîí",
        socks4: "üß¶",
        socks5: "üß¶",
        socks5h: "üß¶",
        unknown: "‚ùì",
      };
      return icons[type] || icons.unknown;
    }

    // Get proxy type
    function getProxyType(value) {
      if (value === "non") return "non";
      if (value === "sys") return "sys";
      try {
        const proxyUrl = new URL(value);
        const protocol = proxyUrl.protocol.replace(":", "");
        return protocol;
      } catch (e) {
        return "unknown";
      }
    }

    // Format proxy type
    function formatProxyType(type) {
      const types = {
        non: "No Proxy",
        sys: "System Proxy",
        http: "HTTP",
        https: "HTTPS",
        socks4: "SOCKS4",
        socks5: "SOCKS5",
        socks5h: "SOCKS5H",
        unknown: "Unknown",
      };
      return types[type] || type;
    }

    // Validate proxy address format
    function validateProxyUrl(url, type) {
      if (type === "non" || type === "sys") return true;

      try {
        const proxyUrl = new URL(url);
        const protocol = proxyUrl.protocol.replace(":", "");

        const validProtocols = [
          "http",
          "https",
          "socks4",
          "socks5",
          "socks5h",
        ];
        if (!validProtocols.includes(protocol)) {
          showToast(`Unsupported proxy protocol: ${protocol}`, "warning");
          return false;
        }

        if (!proxyUrl.hostname || !proxyUrl.port) {
          showToast("Proxy address must include hostname and port", "warning");
          return false;
        }

        return true;
      } catch (e) {
        showToast("Invalid proxy address format", "warning");
        return false;
      }
    }

    // Filter proxies
    function filterProxies() {
      const searchTerm = document
        .getElementById("searchInput")
        .value.toLowerCase();
      const selectedTypes = Array.from(
        document.querySelectorAll(".multiselect-option input:checked"),
      ).map((cb) => cb.value);

      const filteredProxies = Object.entries(allProxies).filter(
        ([name, value]) => {
          const type = getProxyType(value);
          const nameMatch = name.toLowerCase().includes(searchTerm);
          const typeMatch = selectedTypes.includes(type);

          return nameMatch && typeMatch;
        },
      );

      const filteredObj = Object.fromEntries(filteredProxies);
      renderFilteredProxies(filteredObj);
      updateStatusBar(filteredProxies.length);
    }

    // Render filtered proxies
    function renderFilteredProxies(proxies) {
      const temp = allProxies;
      allProxies = proxies;
      renderProxies();
      allProxies = temp;
    }

    // Update status bar
    function updateStatusBar(filteredCount) {
      const total = Object.keys(allProxies).length;
      const selected = selectedProxies.size;
      const selectionStatus = document.getElementById("selectionStatus");
      const totalCount = document.getElementById("totalCount");

      if (selectionStatus) {
        selectionStatus.textContent = `Selected: ${selected}`;
      }
      if (totalCount) {
        const count = filteredCount !== undefined ? filteredCount : total;
        totalCount.textContent = `Total ${count} proxies`;
      }
    }

    // Select proxy
    function selectProxy(name, append = false) {
      if (!name) return;

      if (!append) {
        clearSelection();
      }

      selectedProxies.add(name);
      const row = document.querySelector(`tr[data-name="${name}"]`);
      if (row) {
        row.classList.add("selected");
      }

      updateSelectionStatus();
    }

    // Deselect proxy
    function deselectProxy(name) {
      if (!name) return;

      selectedProxies.delete(name);
      const row = document.querySelector(`tr[data-name="${name}"]`);
      if (row) {
        row.classList.remove("selected");
      }

      updateSelectionStatus();
    }

    // Clear all selection
    function clearSelection() {
      selectedProxies.clear();
      const rows = document.querySelectorAll("#proxyListBody tr.selected");
      rows.forEach((row) => {
        row.classList.remove("selected");
      });

      updateSelectionStatus();
    }

    // Update selection status
    function updateSelectionStatus() {
      updateStatusBar();
    }

    // Show add proxy dialog
    function showAddProxyModal() {
      document.getElementById("proxyName").value = "";
      document.getElementById("proxyType").value = "custom";
      document.getElementById("proxyUrl").value = "";
      toggleProxyUrl();
      showModal("addProxyModal");

      // Focus first input
      setTimeout(() => {
        document.getElementById("proxyName").focus();
      }, 200);
    }

    // Toggle proxy address input display
    function toggleProxyUrl() {
      const type = document.getElementById("proxyType").value;
      const urlGroup = document.getElementById("proxyUrlGroup");
      urlGroup.style.display = type === "custom" ? "block" : "none";
    }

    // Confirm add proxy
    async function confirmAddProxy() {
      const name = document.getElementById("proxyName").value.trim();
      const type = document.getElementById("proxyType").value;
      const url = document.getElementById("proxyUrl").value.trim();

      if (!name) {
        showToast("Please enter proxy name", "warning");
        document.getElementById("proxyName").focus();
        return;
      }

      if (type === "custom") {
        if (!url) {
          showToast("Please enter proxy address", "warning");
          document.getElementById("proxyUrl").focus();
          return;
        }

        if (!validateProxyUrl(url, type)) {
          return;
        }
      }

      closeModal("addProxyModal");
      showToast("Adding proxy...", "info");

      const proxy = {
        [name]: type === "non" || type === "sys" ? type : url,
      };

      const data = await makeAuthenticatedRequest("/proxies/add", {
        body: JSON.stringify({
          proxies: proxy,
        }),
      });

      if (data) {
        showToast(data.message || "Add successful", "success");
        getProxyInfo();
      } else {
        showToast("Add proxy failed", "error");
      }
    }

    // Delete selected proxies
    function deleteSelectedProxies() {
      if (selectedProxies.size === 0) {
        showToast("Please select proxies to delete first", "info");
        return;
      }

      proxiesToDelete = [...selectedProxies];
      document.getElementById("confirmMessage").textContent =
        proxiesToDelete.length > 1
          ? `Are you sure you want to delete ${proxiesToDelete.length} selected proxies?`
          : "Are you sure you want to delete the selected proxy?";

      closeContextMenu();
      showModal("confirmModal");
    }

    // Confirm delete proxies
    async function confirmDeleteProxies() {
      if (proxiesToDelete.length === 0) return;

      closeModal("confirmModal");
      showToast("Deleting proxies...", "info");

      const data = await makeAuthenticatedRequest("/proxies/del", {
        body: JSON.stringify({
          names: proxiesToDelete,
          expectation: "failed_tokens",
        }),
      });

      if (data) {
        const failedCount = data.failed_names?.length || 0;
        const successCount = proxiesToDelete.length - failedCount;
        const message = failedCount
          ? `Delete successful: ${successCount}, Failed: ${failedCount}`
          : `Successfully deleted ${successCount} proxies`;

        showToast(message, "success");
        clearSelection();
        getProxyInfo();
      } else {
        showToast("Delete proxy failed", "error");
      }

      proxiesToDelete = [];
    }

    // Set as general proxy
    async function setAsGeneral() {
      if (selectedProxies.size !== 1) {
        showToast("Please select one proxy to set as general", "info");
        return;
      }

      closeContextMenu();

      const name = [...selectedProxies][0];
      showToast("Setting general proxy...", "info");

      const data = await makeAuthenticatedRequest("/proxies/set-general", {
        body: JSON.stringify({
          name: name,
        }),
      });

      if (data) {
        showToast("General proxy set successfully", "success");
        getProxyInfo();
      } else {
        showToast("Set general proxy failed", "error");
      }
    }

    // Copy proxy address
    async function copyProxyUrl() {
      if (selectedProxies.size === 0) {
        showToast("Please select a proxy first", "info");
        return;
      }

      const name = [...selectedProxies][0];
      const value = allProxies[name];

      closeContextMenu();

      if (typeof value === "string" && value !== "non" && value !== "sys") {
        // Use shared copy method
        const success = await copyToClipboard(value, {
          showMessage: false, // Use custom toast message
          onSuccess: () => {
            showToast("Proxy address copied to clipboard", "success");
          },
          onError: () => {
            showToast("Copy failed, please copy manually", "error");
          },
        });
      } else {
        showToast("This proxy has no copyable address", "warning");
      }
    }

    // Export proxy configuration
    function exportProxies() {
      const config = {
        proxies: allProxies,
        general: generalProxy,
      };

      const jsonData = JSON.stringify(config, null, 2);
      const blob = new Blob([jsonData], { type: "application/json" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = `proxies_export_${new Date().toISOString().slice(0, 10)}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      showToast("Proxy configuration exported", "success");
    }

    // Show import dialog
    function showImportModal() {
      document.getElementById("importFile").value = "";
      document.getElementById("importPreview").style.display = "none";
      document.getElementById("confirmImportBtn").disabled = true;
      showModal("importModal");
    }

    // Preview import file
    function previewImportFile() {
      const fileInput = document.getElementById("importFile");
      const preview = document.getElementById("importPreview");
      const previewContent = document.getElementById("importPreviewContent");
      const confirmBtn = document.getElementById("confirmImportBtn");

      if (!fileInput.files || fileInput.files.length === 0) {
        preview.style.display = "none";
        confirmBtn.disabled = true;
        return;
      }

      const file = fileInput.files[0];
      const reader = new FileReader();

      reader.onload = function (e) {
        try {
          const config = JSON.parse(e.target.result);

          // Validate file format
          if (!config.proxies || typeof config.proxies !== "object") {
            throw new Error("Invalid configuration file format");
          }

          // Show preview
          const proxyCount = Object.keys(config.proxies).length;
          const previewText = `Proxy count: ${proxyCount}\nGeneral proxy: ${config.general || "None"}\n\nProxy list:\n${Object.entries(
            config.proxies,
          )
            .slice(0, 10)
            .map(([name, value]) => `- ${name}: ${value}`)
            .join("\n")}${proxyCount > 10 ? "\n..." : ""}`;

          previewContent.textContent = previewText;
          preview.style.display = "block";
          confirmBtn.disabled = false;
        } catch (error) {
          showToast("Invalid file format: " + error.message, "error");
          preview.style.display = "none";
          confirmBtn.disabled = true;
        }
      };

      reader.readAsText(file);
    }

    // Confirm import
    async function confirmImport() {
      const fileInput = document.getElementById("importFile");

      if (!fileInput.files || fileInput.files.length === 0) {
        showToast("Please select a file to import", "warning");
        return;
      }

      const file = fileInput.files[0];
      const reader = new FileReader();

      reader.onload = async function (e) {
        try {
          const config = JSON.parse(e.target.result);

          closeModal("importModal");
          showToast("Importing proxy configuration...", "info");

          const data = await makeAuthenticatedRequest("/proxies/set", {
            body: JSON.stringify(config),
          });

          if (data) {
            showToast("Proxy configuration imported successfully", "success");
            fileInput.value = "";
            getProxyInfo();
          } else {
            showToast("Import failed", "error");
          }
        } catch (error) {
          showToast("Import failed: " + error.message, "error");
        }
      };

      reader.readAsText(file);
    }

    // Show dialog
    function showModal(modalId) {
      const modal = document.getElementById(modalId);
      const backdrop = document.getElementById(`${modalId}-backdrop`);

      if (modal && backdrop) {
        modal.style.display = "block";
        backdrop.style.display = "block";
      }
    }

    // Close dialog
    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      const backdrop = document.getElementById(`${modalId}-backdrop`);

      if (modal && backdrop) {
        modal.style.display = "none";
        backdrop.style.display = "none";
      }
    }

    // Close all dialogs
    function closeAllModals() {
      const modals = document.querySelectorAll(".modal");
      const backdrops = document.querySelectorAll(".modal-backdrop");

      modals.forEach((modal) => {
        modal.style.display = "none";
      });

      backdrops.forEach((backdrop) => {
        backdrop.style.display = "none";
      });
    }

    // Show notification message
    function showToast(message, type = "info", duration = 3000) {
      // Get or create notification container
      let container = document.getElementById("toast-container");
      if (!container) {
        container = document.createElement("div");
        container.id = "toast-container";
        container.className = "toast-container";
        document.body.appendChild(container);
      }

      // Create new notification element
      const toast = document.createElement("div");
      toast.className = `toast ${type}`;

      // Add text container
      toast.innerHTML = `<div class="toast-content">${message}</div>`;

      // Add to container
      container.appendChild(toast);

      // Force a reflow to ensure transition animation works
      void toast.offsetWidth;

      // Show notification
      requestAnimationFrame(() => {
        toast.classList.add("show");
      });

      // Set auto remove
      setTimeout(() => {
        toast.classList.remove("show");

        // Remove element after notification fade animation completes
        setTimeout(() => {
          if (container.contains(toast)) {
            container.removeChild(toast);
          }

          // If no more notifications, remove container
          if (container.children.length === 0) {
            if (document.body.contains(container)) {
              document.body.removeChild(container);
            }
          }
        }, 400);
      }, duration);

      // Limit max display count
      const maxToasts = 5;
      const toasts = container.querySelectorAll(".toast");
      if (toasts.length > maxToasts) {
        const oldestToast = toasts[0];
        oldestToast.classList.remove("show");
        setTimeout(() => {
          if (container.contains(oldestToast)) {
            container.removeChild(oldestToast);
          }
        }, 400);
      }
    }
  </script>
</body>

</html>